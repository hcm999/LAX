<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAX Staking DApp</title>
    <!-- å¼•å…¥ Bootstrap ç”¨äºå¿«é€Ÿå¸ƒå±€ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Ethers.js V6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        /* ã€å…¨å±€æ ·å¼è®¾ç½®ã€‘ */
        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            min-height: 100vh;
            padding: 5px;
        }
        .container {
            padding-left: 8px;
            padding-right: 8px;
            max-width: 100%;
        }
        .card { 
            background-color: #1e293b; 
            border: 1px solid #334155; 
        }
        .card-title { 
            color: #fff; 
        }
        .btn-primary { 
            background-color: #3b82f6; 
            border: none; 
        }
        .btn-primary:hover { 
            background-color: #2563eb; 
        }
        .btn-success { 
            background-color: #10b981; 
            border: none; 
        }
        .btn-danger { 
            background-color: #ef4444; 
            border: none; 
        }
        .btn-warning { 
            background-color: #f59e0b; 
            border: none; 
            color: #fff; 
        }
        .btn-warning:hover { 
            background-color: #d97706; 
            color: #fff; 
        }
        .stat-value { 
            font-size: 1.25rem; 
            font-weight: bold; 
            color: #38bdf8; 
        }
        .stat-label { 
            font-size: 0.85rem; 
            color: #94a3b8; 
        }
        
        /* ã€è´¨æŠ¼æ“ä½œåŒºåŸŸç¾åŒ–æ ·å¼ã€‘ */
        .stake-operation-card {
            background: linear-gradient(145deg, #0d2739, #123047);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .stake-operation-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .stake-input-group {
            margin-bottom: 15px;
        }
        
        .stake-input-label {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 8px;
            display: block;
        }
        
        .stake-amount-input {
            width: 100%;
            padding: 12px;
            background-color: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .stake-amount-input:focus {
            outline: none;
            border-color: #0d9488;
            box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.2);
        }
        
        .duration-buttons {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .duration-btn {
            flex: 1;
            padding: 10px 4px;
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 2px solid #334155;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .duration-btn:hover {
            border-color: #0d9488;
            color: #0d9488;
            transform: translateY(-2px);
        }
        
        .duration-btn.active {
            background: linear-gradient(90deg, #0d9488, #0a6c5f);
            border-color: #0d9488;
            color: white;
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
        }
        
        .stake-action-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(90deg, #0d9488, #0a6c5f);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stake-action-btn:hover {
            background: linear-gradient(90deg, #0a6c5f, #0d9488);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(13, 148, 136, 0.4);
        }
        
        .stake-action-btn:disabled {
            background: #475569;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* ã€è´¨æŠ¼è®°å½•å¡ç‰‡æ ·å¼ã€‘ */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stake-card {
            background: linear-gradient(145deg, #0d9488, #134e4a);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            border: 1px solid #14b8a6;
            line-height: 1.4;
        }
        
        .card-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .card-id {
            font-size: 0.85rem;
            color: #cbd5e1;
            font-weight: 500;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 10px;
            border-radius: 20px;
        }
        
        .card-duration {
            font-size: 1.3rem;
            font-weight: 600;
            color: #ffffff;
        }
        
        .card-amount {
            font-size: 1.3rem;
            font-weight: 600;
            color: #ffffff;
        }
        
        .card-middle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stake-time {
            font-size: 1.1rem;
            color: #ffffff;
            font-weight: 500;
        }
        
        .remaining-time {
            font-size: 0.95rem;
            color: #ffffff;
        }
        
        .progress-container {
            margin-bottom: 20px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .progress-label {
            font-size: 0.85rem;
            color: #cbd5e1;
        }
        
        .progress-percentage {
            font-size: 0.85rem;
            color: #ffffff;
            font-weight: 500;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        .button-container {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }
        
        .btn {
            flex: none;
            width: 130px;
            color: white;
            border: none;
            padding: 10px 0;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-locked {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .btn-locked:hover:not(:disabled) {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
        }
        
        .btn-redeemable {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .btn-redeemable:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
        }
        
        .btn-extracted {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            cursor: not-allowed;
        }
        
        .btn-waiting {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            cursor: not-allowed;
        }
        
        .btn-redeem-now {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #1c1917;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        
        .btn-redeem-now:hover:not(:disabled) {
            background: linear-gradient(135deg, #d97706, #b45309);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        .btn-redeemed {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            cursor: not-allowed;
        }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* ç©ºçŠ¶æ€æ ·å¼ */
        .stake-empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 25px 12px;
            color: #94a3b8;
            background-color: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            border: 2px dashed #475569;
        }
        
        .stake-empty-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: #475569;
        }
        
        .stake-empty-text {
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        
        .stake-empty-subtext {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        /* ã€çŠ¶æ€ç­›é€‰æŒ‰é’®æ ·å¼ã€‘ */
        .status-filter {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .status-filter-btn {
            font-size: 0.95rem;
            padding: 3px 10px;
            border-radius: 20px;
            border: 1px solid #475569;
            background-color: #1e293b;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .status-filter-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .status-filter-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        /* ã€å“åº”å¼è°ƒæ•´ã€‘ */
        @media (max-width: 768px) {
            body {
                padding: 3px;
            }
            
            .container {
                padding-left: 5px;
                padding-right: 5px;
                max-width: 100%;
            }
            
            .cards-container {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-top: 12px;
                padding: 0 2px;
            }
            
            .stake-card {
                padding: 12px;
                margin: 0;
                line-height: 1.5;
            }
            
            .card-top-row {
                margin-bottom: 12px;
                padding-bottom: 8px;
            }
            
            .card-id {
                font-size: 0.8rem;
                padding: 3px 8px;
            }
            
            .card-duration, .card-amount {
                font-size: 1.1rem;
            }
            
            .stake-time {
                font-size: 0.95rem;
            }
            
            .remaining-time {
                font-size: 0.85rem;
            }
            
            .btn {
                width: 110px;
                font-size: 0.9rem;
                padding: 8px 0;
            }
            
            .button-container {
                gap: 8px;
            }
            
            .card-middle-row {
                margin-bottom: 12px;
            }
            
            .progress-container {
                margin-bottom: 15px;
            }
            
            .progress-label, .progress-percentage {
                font-size: 0.8rem;
            }
            
            .progress-bar {
                height: 6px;
            }
            
            .row.mb-4.text-center.g-2 {
                margin-bottom: 15px !important;
            }
            
            .card.p-3.h-100 {
                padding: 12px !important;
            }
            
            .stat-value {
                font-size: 1.1rem;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
            
            .stake-operation-card {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .stake-operation-title {
                font-size: 1rem;
                margin-bottom: 12px;
            }
            
            .stake-amount-input {
                padding: 10px;
                font-size: 0.95rem;
            }
            
            .duration-btn {
                padding: 8px 3px;
                font-size: 0.8rem;
            }
            
            .stake-action-btn {
                padding: 12px;
                font-size: 0.95rem;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1200px) {
            .cards-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 18px;
            }
        }
        
        @media (min-width: 1201px) {
            .cards-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
            }
        }
        
        /* ã€æ€»ç»Ÿè®¡æ•°æ®å¡ç‰‡æ ·å¼ã€‘ */
        .total-stats-card { 
            border-left: 4px solid #3b82f6; 
        }
        
        /* ã€é’±åŒ…åœ°å€ç¼©çŸ­æ˜¾ç¤ºæ ·å¼ã€‘ */
        .address-short { 
            font-family: 'Courier New', monospace; 
            background-color: #1f2937; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
<div class="container py-3">
    <!-- ã€é’±åŒ…è¿æ¥åŒºåŸŸã€‘ -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold">USDT Staking</h3>
        <button id="connectBtn" class="btn btn-primary" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
    </div>

    <!-- ã€æ•°æ®ç»Ÿè®¡é¢æ¿ã€‘ -->
    <div class="row mb-3 text-center g-2">
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">æˆ‘çš„ USDT ä½™é¢</div>
                <div class="stat-value" id="myBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">è´¨æŠ¼ä¸­ USDT</div>
                <div class="stat-value" id="stakedBalance">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100">
                <div class="stat-label">å¾…é¢†å–å¥–åŠ±</div>
                <div class="stat-value" id="pendingRewards">0.0000</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card p-3 h-100 total-stats-card">
                <div class="stat-label">åˆçº¦æ€»è´¨æŠ¼</div>
                <div class="stat-value" id="totalStaked">0.0000</div>
            </div>
        </div>
    </div>

    <!-- ã€è´¨æŠ¼æ“ä½œåŒºåŸŸã€‘ -->
    <div class="stake-operation-card">
        <div class="stake-operation-title">å‚ä¸è´¨æŠ¼</div>
        
        <div class="stake-input-group">
            <label class="stake-input-label">è´¨æŠ¼é‡‘é¢ (USDT)</label>
            <input type="number" class="stake-amount-input" id="stakeAmount" value="1000" placeholder="è¾“å…¥é‡‘é¢">
        </div>
        
        <div class="duration-selection">
            <label class="stake-input-label">é€‰æ‹©è´¨æŠ¼å‘¨æœŸ</label>
            <div class="duration-buttons">
                <button class="duration-btn active" onclick="selectDuration(0, this)">1å¤©</button>
                <button class="duration-btn" onclick="selectDuration(1, this)">15å¤©</button>
                <button class="duration-btn" onclick="selectDuration(2, this)">30å¤©</button>
            </div>
        </div>
        
        <button class="stake-action-btn" onclick="handleStake()">ç«‹å³è´¨æŠ¼</button>
    </div>

    <!-- ã€æˆ‘çš„è´¨æŠ¼è®°å½•åŒºåŸŸã€‘ -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">æˆ‘çš„è´¨æŠ¼è®°å½•</h5>
                <div>
                    <button class="btn btn-sm btn-outline-light" onclick="refreshData()">åˆ·æ–°æ•°æ®</button>
                </div>
            </div>
            
            <!-- ã€çŠ¶æ€ç­›é€‰ã€‘ -->
            <div class="status-filter">
                <button class="status-filter-btn active" onclick="filterMyStakes('active')">è´¨æŠ¼ä¸­</button>
                <button class="status-filter-btn" onclick="filterMyStakes('completed')">å·²èµå›</button>
                <button class="status-filter-btn" onclick="filterMyStakes('all')">å…¨éƒ¨è®°å½•</button>
            </div>
            
            <!-- ã€å¡ç‰‡å¼å¸ƒå±€å®¹å™¨ã€‘ -->
            <div id="stakeCardsContainer" class="cards-container">
                <div class="stake-empty-state">
                    <div class="stake-empty-icon">ğŸ“Š</div>
                    <div class="stake-empty-text">æš‚æ— è´¨æŠ¼è®°å½•</div>
                    <div class="stake-empty-subtext">è¿æ¥é’±åŒ…åï¼Œæ‚¨çš„è´¨æŠ¼è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¼•å…¥ Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ================= ã€é…ç½®åŒºåŸŸã€‘ =================
    const CONFIG = {
        STAKING: "0x3790715d5458397600f524dbe8269b7498f6a9fe",  // è´¨æŠ¼åˆçº¦åœ°å€
        USDT: "0x55d398326f99059fF775485246999027B3197955",    // USDTä»£å¸åœ°å€ï¼ˆBSCä¸Šçš„USDTï¼‰
    };
    
    // ã€è´¨æŠ¼å‘¨æœŸé…ç½® (å¤©)ã€‘
    const STAKE_DURATIONS = {
        0: 1,    // 1å¤©
        1: 15,   // 15å¤©
        2: 30    // 30å¤©
    };
    
    const STAKE_DURATION_LABELS = {
        0: "1å¤©",
        1: "15å¤©", 
        2: "30å¤©"
    };
    // ===============================================

    // ================= ã€ABIé…ç½®ã€‘ =================
    // ã€USDTä»£å¸ABIã€‘
    const ABI_ERC20 = [
        "function balanceOf(address owner) view returns (uint256)",
        "function decimals() view returns (uint8)",
        "function approve(address spender, uint256 amount) returns (bool)",
        "function allowance(address owner, address spender) view returns (uint256)"
    ];

    // ã€è´¨æŠ¼åˆçº¦ABI - åŸºäºç”¨æˆ·æä¾›çš„ABIã€‘
    const ABI_STAKING = [
        "function totalSupply() view returns (uint256)",
        "function balanceOf(address account) view returns (uint256)",
        "function stakeFor(address user, uint160 amount, uint8 stakeIndex)",
        "function unstakeFor(address user, uint256 index) returns (uint256 actualAmount)",
        "function stakeCount(address user) view returns (uint256 count)",
        "function getStakeRecord(address user, uint256 index) view returns (tuple(uint40 stakeTime, uint160 amount, uint8 stakeIndex, uint40 unstakeTime, uint160 reward, uint40 restakeTime) record)",
        "function rewardOfSlot(address user, uint8 index) view returns (uint256 reward)",
        "function claimFor(address user, uint256 _index)",
        "function MIN_STAKE_AMOUNT() view returns (uint256)"
    ];
    // ===============================================

    // ã€å…¨å±€å˜é‡ã€‘
    let provider, signer, userAddress;
    let stakingContract, usdtContract;
    let countdownTimers = {};
    let selectedDuration = 0; // é»˜è®¤é€‰æ‹©1å¤©
    
    // ã€ç­›é€‰çŠ¶æ€ã€‘
    let myStakeFilter = 'active'; // æˆ‘çš„è´¨æŠ¼è®°å½•ç­›é€‰ï¼šactive=è´¨æŠ¼ä¸­, completed=å·²èµå›, all=å…¨éƒ¨

    // ã€å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–é‡‘é¢ä¸º4ä½å°æ•°ã€‘
    function formatAmount(wei) {
        const val = ethers.formatUnits(wei, 18);
        return parseFloat(val).toFixed(4);
    }

    // ã€å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–é‡‘é¢ä¸º2ä½å°æ•°ã€‘
    function formatAmountTwoDecimals(wei) {
        const val = ethers.formatUnits(wei, 18);
        return parseFloat(val).toFixed(2);
    }

    // ã€å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–å‰©ä½™æ—¶é—´ã€‘
    function formatTimeRemaining(seconds) {
        if (seconds <= 0) return "0ç§’";
        
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        let result = "";
        if (days > 0) result += `${days}å¤©`;
        if (hours > 0) result += `${hours}å°æ—¶`;
        if (minutes > 0 && days === 0) result += `${minutes}åˆ†`;
        if (secs > 0 && days === 0 && hours === 0) result += `${secs}ç§’`;
        
        return result || "0ç§’";
    }
    
    // ã€å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´ä¸ºçŸ­æ ¼å¼ã€‘
    function formatTimeShort(seconds) {
        if (seconds <= 0) return "0s";
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        let result = "";
        if (hours > 0) result += `${hours}h`;
        if (minutes > 0) result += `${minutes}m`;
        if (secs > 0 && hours === 0) result += `${secs}s`;
        
        return result || "0s";
    }
    
    // ã€å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–è´¨æŠ¼æ—¶é—´ã€‘
    function formatStakeTime(timestamp) {
        const date = new Date(timestamp * 1000);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hour = date.getHours().toString().padStart(2, '0');
        const minute = date.getMinutes().toString().padStart(2, '0');
        
        return `${month}/${day} ${hour}:${minute}`;
    }
    
    // ã€å·¥å…·å‡½æ•°ï¼šè®¡ç®—è¿›åº¦æ¡ç™¾åˆ†æ¯”ã€‘
    function calculateProgress(stakeTime, durationSeconds) {
        const now = Math.floor(Date.now() / 1000);
        const elapsedTime = now - stakeTime;
        
        if (elapsedTime >= durationSeconds) {
            return 100;
        }
        
        return Math.min(100, Math.floor((elapsedTime / durationSeconds) * 100));
    }
    
    // ã€å·¥å…·å‡½æ•°ï¼šç¼©çŸ­åœ°å€æ˜¾ç¤ºã€‘
    function shortenAddress(address) {
        if (!address) return '';
        return address.substring(0, 6) + '...' + address.substring(address.length - 4);
    }
    
    // ã€é€‰æ‹©è´¨æŠ¼å‘¨æœŸã€‘
    function selectDuration(index, element) {
        selectedDuration = index;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.duration-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        element.classList.add('active');
    }
    
    // ã€æ¿€æ´»ç­›é€‰æŒ‰é’®ã€‘
    function activateFilterButton(containerClass, activeIndex) {
        const buttons = document.querySelectorAll(`${containerClass} .status-filter-btn`);
        buttons.forEach((btn, index) => {
            btn.classList.remove('active');
            if (index === activeIndex) {
                btn.classList.add('active');
            }
        });
    }

    // ã€ç­›é€‰æˆ‘çš„è´¨æŠ¼è®°å½•ã€‘
    function filterMyStakes(filterType) {
        myStakeFilter = filterType;
        renderStakeCards();
        
        // æ¿€æ´»å¯¹åº”çš„ç­›é€‰æŒ‰é’®
        let activeIndex = 0;
        if (filterType === 'completed') activeIndex = 1;
        else if (filterType === 'all') activeIndex = 2;
        activateFilterButton('.status-filter', activeIndex);
    }
    
    // ã€æ ¹æ®çŠ¶æ€è·å–æŒ‰é’®é…ç½®ã€‘
    function getButtonConfig(status) {
        switch(status) {
            case "locked":
                return {
                    leftBtn: {
                        text: "é”å®šä¸­",
                        class: "btn btn-locked",
                        disabled: false
                    },
                    rightBtn: {
                        text: "ç­‰å¾…è§£é”",
                        class: "btn btn-waiting",
                        disabled: true
                    },
                    progressColor: "linear-gradient(90deg, #fbbf24, #f59e0b)"
                };
            case "redeemable":
                return {
                    leftBtn: {
                        text: "å¯èµå›",
                        class: "btn btn-redeemable",
                        disabled: false
                    },
                    rightBtn: {
                        text: "ç«‹å³èµå›",
                        class: "btn btn-redeem-now",
                        disabled: false
                    },
                    progressColor: "linear-gradient(90deg, #fbbf24, #f59e0b)"
                };
            case "redeemed":
                return {
                    leftBtn: {
                        text: "å·²æå–",
                        class: "btn btn-extracted",
                        disabled: true
                    },
                    rightBtn: {
                        text: "å·²èµå›",
                        class: "btn btn-redeemed",
                        disabled: true
                    },
                    progressColor: "linear-gradient(90deg, #a1a1aa, #71717a)"
                };
            default:
                return getButtonConfig("locked");
        }
    }
    
    // ã€1. è¿æ¥é’±åŒ…ã€‘
    async function connectWallet() {
        if (!window.ethereum) {
            alert("è¯·å®‰è£… MetaMask!");
            return;
        }
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            
            // æ›´æ–°UI
            document.getElementById('connectBtn').innerText = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
            document.getElementById('connectBtn').classList.replace('btn-primary', 'btn-success');

            // åˆå§‹åŒ–åˆçº¦
            stakingContract = new ethers.Contract(CONFIG.STAKING, ABI_STAKING, signer);
            usdtContract = new ethers.Contract(CONFIG.USDT, ABI_ERC20, signer);

            // åŠ è½½æ•°æ®
            await refreshData();
        } catch (error) {
            console.error("è¿æ¥å¤±è´¥:", error);
            alert("è¿æ¥é’±åŒ…å¤±è´¥");
        }
    }

    // ã€2. åˆ·æ–°æ‰€æœ‰æ•°æ®ã€‘
    async function refreshData() {
        if (!userAddress) return;
        const btn = document.querySelector('button[onclick="refreshData()"]');
        const originalText = btn.innerText;
        btn.innerText = "åŠ è½½ä¸­...";
        
        try {
            // 2.1 è·å–æˆ‘çš„ USDT ä½™é¢
            const myBal = await usdtContract.balanceOf(userAddress);
            document.getElementById('myBalance').innerText = formatAmount(myBal);

            // 2.2 è·å–è´¨æŠ¼ä¸­ä½™é¢
            const stakedBal = await stakingContract.balanceOf(userAddress);
            document.getElementById('stakedBalance').innerText = formatAmount(stakedBal);

            // 2.3 è·å–å¾…é¢†å–å¥–åŠ±
            let totalRewards = ethers.BigNumber.from(0);
            for (let i = 0; i < 3; i++) {
                try {
                    const reward = await stakingContract.rewardOfSlot(userAddress, i);
                    totalRewards = totalRewards.add(reward);
                } catch (error) {
                    console.log(`è·å–ç¬¬${i}ä¸ªå¥–åŠ±æ§½å¤±è´¥:`, error);
                }
            }
            document.getElementById('pendingRewards').innerText = formatAmount(totalRewards);
            
            // 2.4 è·å–åˆçº¦æ€»è´¨æŠ¼é‡‘é¢
            const totalStaked = await stakingContract.totalSupply();
            document.getElementById('totalStaked').innerText = formatAmount(totalStaked);

            // 2.5 è·å–è´¨æŠ¼åˆ—è¡¨
            await renderStakeCards();
            btn.innerText = "åˆ·æ–°";
        } catch (error) {
            console.error("æ•°æ®åŠ è½½é”™è¯¯:", error);
        } finally {
            btn.innerText = originalText;
        }
    }

    // ã€3. æ¸²æŸ“è´¨æŠ¼å¡ç‰‡ã€‘
    async function renderStakeCards() {
        const container = document.getElementById('stakeCardsContainer');
        container.innerHTML = '<div class="text-center py-3"><div class="loading-spinner"></div> åŠ è½½ä¸­...</div>';

        try {
            const count = await stakingContract.stakeCount(userAddress);
            
            if (Number(count) === 0) {
                container.innerHTML = `
                    <div class="stake-empty-state">
                        <div class="stake-empty-icon">ğŸ“Š</div>
                        <div class="stake-empty-text">æš‚æ— è´¨æŠ¼è®°å½•</div>
                        <div class="stake-empty-subtext">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡è´¨æŠ¼å§ï¼</div>
                    </div>
                `;
                return;
            }

            let html = '';
            const now = Math.floor(Date.now() / 1000);
            let activeCount = 0; // è´¨æŠ¼ä¸­æ•°é‡
            let completedCount = 0; // å·²èµå›æ•°é‡
            let displayedCount = 0; // æ˜¾ç¤ºæ•°é‡

            // æ¸…ç©ºæ—§çš„å€’è®¡æ—¶å®šæ—¶å™¨
            Object.keys(countdownTimers).forEach(id => {
                clearInterval(countdownTimers[id]);
                delete countdownTimers[id];
            });

            // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            for (let i = Number(count) - 1; i >= 0; i--) {
                try {
                    const record = await stakingContract.getStakeRecord(userAddress, i);
                    
                    const amount = parseFloat(ethers.formatUnits(record.amount, 18));
                    const stakeTime = Number(record.stakeTime);
                    const unstakeTime = Number(record.unstakeTime);
                    const stakeIndex = Number(record.stakeIndex);
                    const reward = parseFloat(ethers.formatUnits(record.reward, 18));
                    
                    const stakeTimeStr = formatStakeTime(stakeTime);
                    const durationDays = STAKE_DURATIONS[stakeIndex] || 1;
                    const durationLabel = STAKE_DURATION_LABELS[stakeIndex] || "æœªçŸ¥";
                    const durationSeconds = durationDays * 86400;
                    
                    // è®¡ç®—è§£é”æ—¶é—´
                    const unlockTime = stakeTime + durationSeconds;
                    const timeRemaining = unlockTime - now;
                    
                    // åˆ¤æ–­çŠ¶æ€
                    const isActive = unstakeTime > 0; // å·²èµå›
                    const isLocked = timeRemaining > 0 && !isActive;
                    const isUnlocked = timeRemaining <= 0 && !isActive;
                    
                    // è®¡ç®—è¿›åº¦æ¡ç™¾åˆ†æ¯”
                    const progressPercent = calculateProgress(stakeTime, durationSeconds);
                    
                    // ç¡®å®šçŠ¶æ€
                    let status = '';
                    if (isActive) {
                        status = 'redeemed';
                        completedCount++;
                    } else if (isLocked) {
                        status = 'locked';
                        activeCount++;
                    } else if (isUnlocked) {
                        status = 'redeemable';
                        activeCount++;
                    } else {
                        status = 'locked';
                    }
                    
                    // æ ¹æ®ç­›é€‰æ¡ä»¶å†³å®šæ˜¯å¦æ˜¾ç¤º
                    let shouldDisplay = false;
                    if (myStakeFilter === 'all') {
                        shouldDisplay = true;
                    } else if (myStakeFilter === 'active') {
                        shouldDisplay = !isActive; // æ˜¾ç¤ºæœªæå–çš„ï¼ˆè´¨æŠ¼ä¸­ï¼‰
                    } else if (myStakeFilter === 'completed') {
                        shouldDisplay = isActive; // æ˜¾ç¤ºå·²æå–çš„
                    }
                    
                    if (!shouldDisplay) {
                        continue; // è·³è¿‡ä¸æ˜¾ç¤º
                    }
                    
                    displayedCount++;
                    
                    // è®¡ç®—å‰©ä½™æ—¶é—´
                    const remainingTimeStr = isLocked ? `å‰©ä½™: ${formatTimeShort(timeRemaining)}` : 
                                              isUnlocked ? 'å·²åˆ°æœŸ' : 'å·²å®Œæˆ';

                    // è·å–æŒ‰é’®é…ç½®
                    const btnConfig = getButtonConfig(status);
                    
                    // åˆ›å»ºå¡ç‰‡HTML
                    html += `
                        <div class="stake-card" id="stake-card-${i}">
                            <!-- é¡¶éƒ¨åŒºåŸŸï¼šç¼–å· | æœŸé™ | é‡‘é¢ -->
                            <div class="card-top-row">
                                <div class="card-id">No.${i + 1}</div>
                                <div class="card-duration">${durationLabel}</div>
                                <div class="card-amount">${amount.toFixed(0)} USDT</div>
                            </div>
                            
                            <!-- ä¸­é—´åŒºåŸŸï¼šæ—¶é—´å’Œå‰©ä½™æ—¶é—´ -->
                            <div class="card-middle-row">
                                <div class="stake-time">${stakeTimeStr}</div>
                                <div class="remaining-time">${remainingTimeStr}</div>
                            </div>
                            
                            <!-- è¿›åº¦æ¡åŒºåŸŸ -->
                            <div class="progress-container">
                                <div class="progress-header">
                                    <div class="progress-label">è´¨æŠ¼è¿›åº¦</div>
                                    <div class="progress-percentage">${progressPercent}%</div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progress-${i}" style="width: ${progressPercent}%; background: ${btnConfig.progressColor};"></div>
                                </div>
                            </div>
                            
                            <!-- æŒ‰é’®åŒºåŸŸ -->
                            <div class="button-container">
                                <button class="${btnConfig.leftBtn.class}" ${btnConfig.leftBtn.disabled ? 'disabled' : ''} data-card-id="No.${i + 1}" data-action="left" data-index="${i}">
                                    ${btnConfig.leftBtn.text}
                                </button>
                                <button class="${btnConfig.rightBtn.class}" ${btnConfig.rightBtn.disabled ? 'disabled' : ''} data-card-id="No.${i + 1}" data-action="right" data-index="${i}">
                                    ${btnConfig.rightBtn.text}
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // å¦‚æœé”å®šä¸­ï¼Œå¯åŠ¨å€’è®¡æ—¶
                    if (isLocked) {
                        startProgressCountdown(i, timeRemaining, durationSeconds);
                    }
                } catch (error) {
                    console.error(`è·å–è´¨æŠ¼è®°å½• ${i} å¤±è´¥:`, error);
                }
            }

            if (displayedCount === 0) {
                let emptyText = '';
                if (myStakeFilter === 'active') {
                    emptyText = 'æš‚æ— è´¨æŠ¼ä¸­çš„è®°å½•';
                } else if (myStakeFilter === 'completed') {
                    emptyText = 'æš‚æ— å·²èµå›çš„è®°å½•';
                } else {
                    emptyText = 'æš‚æ— è´¨æŠ¼è®°å½•';
                }
                
                container.innerHTML = `
                    <div class="stake-empty-state">
                        <div class="stake-empty-icon">ğŸ“Š</div>
                        <div class="stake-empty-text">${emptyText}</div>
                        <div class="stake-empty-subtext">${myStakeFilter === 'active' ? 'å¼€å§‹è´¨æŠ¼ä»¥åˆ›å»ºæ–°çš„è´¨æŠ¼è®°å½•' : 'å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡è´¨æŠ¼å§ï¼'}</div>
                    </div>
                `;
            } else {
                container.innerHTML = html;
                
                // æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                attachButtonEvents();
                
                // è¿›åº¦æ¡åŠ¨ç”»æ•ˆæœ
                setTimeout(() => {
                    document.querySelectorAll('.progress-fill').forEach(fill => {
                        const width = fill.style.width;
                        fill.style.width = '0%';
                        
                        setTimeout(() => {
                            fill.style.transition = 'width 1.5s ease-in-out';
                            fill.style.width = width;
                        }, 300);
                    });
                }, 500);
            }
        } catch (error) {
            console.error("å¡ç‰‡åŠ è½½å¤±è´¥:", error);
            container.innerHTML = `
                <div class="stake-empty-state">
                    <div class="stake-empty-icon">âŒ</div>
                    <div class="stake-empty-text">åŠ è½½å¤±è´¥</div>
                    <div class="stake-empty-subtext">è¯·åˆ·æ–°é¡µé¢é‡è¯•</div>
                </div>
            `;
        }
    }

    // ã€æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶ã€‘
    function attachButtonEvents() {
        // ä¸ºç«‹å³èµå›æŒ‰é’®æ·»åŠ äº‹ä»¶
        document.querySelectorAll('.btn-redeem-now').forEach(button => {
            button.addEventListener('click', function() {
                const index = this.getAttribute('data-index');
                const originalText = this.textContent;
                
                // ä¿å­˜åŸå§‹æ–‡æœ¬
                this.textContent = "èµå›ä¸­...";
                this.disabled = true;
                
                handleUnstake(index)
                    .finally(() => {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        this.textContent = originalText;
                        this.disabled = false;
                    });
            });
        });

        // ä¸ºå…¶ä»–æŒ‰é’®æ·»åŠ åŸæœ‰äº‹ä»¶
        document.querySelectorAll('.btn:not(.btn-redeem-now):not(:disabled)').forEach(button => {
            button.addEventListener('click', function() {
                const cardId = this.getAttribute('data-card-id');
                const action = this.getAttribute('data-action');
                const index = this.getAttribute('data-index');
                const buttonText = this.textContent;
                
                const originalText = this.textContent;
                
                if (buttonText === "é”å®šä¸­") {
                    this.textContent = "å¤„ç†ä¸­...";
                    setTimeout(() => {
                        this.textContent = originalText;
                        alert(`å¡ç‰‡ ${cardId} çš„é”å®šçŠ¶æ€æ— æ³•æ›´æ”¹ï¼Œè¯·ç­‰å¾…è§£é”ã€‚`);
                    }, 1000);
                } else if (buttonText === "å¯èµå›") {
                    this.textContent = "æ£€æŸ¥ä¸­...";
                    setTimeout(() => {
                        this.textContent = originalText;
                        alert(`å¡ç‰‡ ${cardId} çš„å¯èµå›çŠ¶æ€ç¡®è®¤ï¼Œè¯·ç‚¹å‡»"ç«‹å³èµå›"æŒ‰é’®è¿›è¡Œèµå›æ“ä½œã€‚`);
                    }, 1000);
                }
            });
        });
    }

    // ã€å¯åŠ¨è¿›åº¦æ¡å€’è®¡æ—¶ã€‘
    function startProgressCountdown(id, initialSeconds, totalSeconds) {
        let remaining = initialSeconds;
        const progressElement = document.getElementById(`progress-${id}`);
        const timeElement = document.querySelector(`#stake-card-${id} .remaining-time`);
        
        if (!progressElement || !timeElement) return;
        
        const timer = setInterval(() => {
            remaining--;
            
            if (remaining <= 0) {
                clearInterval(timer);
                // åˆ·æ–°æ•´ä¸ªåˆ—è¡¨
                refreshData();
                return;
            }
            
            // æ›´æ–°å‰©ä½™æ—¶é—´æ˜¾ç¤º
            timeElement.textContent = `å‰©ä½™: ${formatTimeShort(remaining)}`;
            
            // æ›´æ–°è¿›åº¦æ¡
            const elapsedSeconds = totalSeconds - remaining;
            const progressPercent = Math.min(100, Math.floor((elapsedSeconds / totalSeconds) * 100));
            progressElement.style.width = `${progressPercent}%`;
            
            // æ›´æ–°ç™¾åˆ†æ¯”æ˜¾ç¤º
            const percentElement = document.querySelector(`#stake-card-${id} .progress-percentage`);
            if (percentElement) {
                percentElement.textContent = `${progressPercent}%`;
            }
            
        }, 1000);
        
        countdownTimers[id] = timer;
    }

    // ã€4. è´¨æŠ¼é€»è¾‘ã€‘
    async function handleStake() {
        if (!userAddress) {
            alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
        }
        
        const amountStr = document.getElementById('stakeAmount').value;
        if (!amountStr || parseFloat(amountStr) <= 0) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è´¨æŠ¼é‡‘é¢");
            return;
        }
        
        // é‡‘é¢éªŒè¯
        const amount = parseFloat(amountStr);
        if (amount < 0.1) { // æœ€å°è´¨æŠ¼é‡‘é¢æ£€æŸ¥
            alert("è´¨æŠ¼é‡‘é¢ä¸èƒ½å°äº0.1 USDT");
            return;
        }
        
        if (amount > 1000000) { // æœ€å¤§è´¨æŠ¼é‡‘é¢æ£€æŸ¥
            alert("è´¨æŠ¼é‡‘é¢ä¸èƒ½è¶…è¿‡1,000,000 USDT");
            return;
        }
        
        try {
            const amountWei = ethers.parseUnits(amountStr, 18);
            const stakeBtn = document.querySelector('.stake-action-btn');
            const originalText = stakeBtn.textContent;
            
            try {
                stakeBtn.disabled = true;
                stakeBtn.textContent = "å¤„ç†ä¸­...";
                
                // 0. æ£€æŸ¥ç½‘ç»œ
                await checkNetwork();
                
                // 1. æ£€æŸ¥ç”¨æˆ·ä½™é¢æ˜¯å¦è¶³å¤Ÿ
                stakeBtn.textContent = "æ£€æŸ¥ä½™é¢...";
                const myBal = await usdtContract.balanceOf(userAddress);
                if (myBal < amountWei) {
                    alert("USDTä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼");
                    throw new Error("ä½™é¢ä¸è¶³");
                }
                
                // 2. æ£€æŸ¥æœ€å°è´¨æŠ¼é™é¢
                stakeBtn.textContent = "æ£€æŸ¥é™é¢...";
                try {
                    const minStakeAmount = await stakingContract.MIN_STAKE_AMOUNT();
                    if (minStakeAmount !== undefined && amountWei < minStakeAmount) {
                        alert(`è´¨æŠ¼é‡‘é¢ä½äºæœ€å°é™é¢ ${ethers.formatUnits(minStakeAmount, 18)} USDT`);
                        throw new Error("ä½äºæœ€å°é™é¢");
                    }
                } catch (minStakeError) {
                    console.log("MIN_STAKE_AMOUNTå‡½æ•°å¯èƒ½ä¸å­˜åœ¨ï¼Œè·³è¿‡é™é¢æ£€æŸ¥");
                }
                
                // 3. æ£€æŸ¥å¹¶æˆæƒ USDT
                stakeBtn.textContent = "æ£€æŸ¥æˆæƒ...";
                const allowance = await usdtContract.allowance(userAddress, CONFIG.STAKING);
                
                if (allowance < amountWei) {
                    stakeBtn.textContent = "æ­£åœ¨æˆæƒ USDT...";
                    try {
                        const txApprove = await usdtContract.approve(CONFIG.STAKING, ethers.MaxUint256);
                        
                        console.log("æˆæƒäº¤æ˜“å“ˆå¸Œ:", txApprove.hash);
                        
                        // ç­‰å¾…æˆæƒç¡®è®¤
                        stakeBtn.textContent = "ç­‰å¾…æˆæƒç¡®è®¤...";
                        const receipt = await txApprove.wait();
                        console.log("æˆæƒç¡®è®¤ï¼ŒåŒºå—:", receipt.blockNumber);
                        
                        // æˆæƒåç­‰å¾…å‡ ç§’
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    } catch (approveError) {
                        console.error("æˆæƒå¤±è´¥:", approveError);
                        
                        if (approveError.code === 4001) {
                            alert("ç”¨æˆ·æ‹’ç»æˆæƒ");
                        } else if (approveError.code === -32603) {
                            alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥Gasè®¾ç½®");
                        } else {
                            alert(`æˆæƒå¤±è´¥: ${approveError.reason || approveError.message || "æœªçŸ¥é”™è¯¯"}`);
                        }
                        throw approveError;
                    }
                }
                
                // 4. ç¡®è®¤å¯¹è¯æ¡†
                const confirmStake = confirm(
                    `ç¡®è®¤è´¨æŠ¼ ${amountStr} USDT\n` +
                    `è´¨æŠ¼å‘¨æœŸ: ${STAKE_DURATION_LABELS[selectedDuration]}\n` +
                    `\næ˜¯å¦ç»§ç»­ï¼Ÿ`
                );
                
                if (!confirmStake) {
                    console.log("ç”¨æˆ·å–æ¶ˆè´¨æŠ¼");
                    throw new Error("ç”¨æˆ·å–æ¶ˆ");
                }
                
                // 5. å‘èµ·è´¨æŠ¼
                stakeBtn.textContent = "æ­£åœ¨è´¨æŠ¼...";
                
                try {
                    // è°ƒç”¨è´¨æŠ¼å‡½æ•°
                    const txStake = await stakingContract.stakeFor(
                        userAddress,
                        amountWei,
                        selectedDuration,
                        { gasLimit: 500000 }
                    );
                    
                    console.log("è´¨æŠ¼äº¤æ˜“å·²å‘é€ï¼Œå“ˆå¸Œ:", txStake.hash);
                    
                    // æ˜¾ç¤ºäº¤æ˜“å·²å‘é€
                    stakeBtn.textContent = "ç­‰å¾…ç¡®è®¤...";
                    alert(`è´¨æŠ¼äº¤æ˜“å·²å‘é€ï¼Œè¯·ç­‰å¾…ç¡®è®¤\näº¤æ˜“å“ˆå¸Œ: ${txStake.hash.substring(0, 10)}...`);
                    
                    // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                    const receipt = await txStake.wait();
                    console.log("è´¨æŠ¼ç¡®è®¤ï¼ŒåŒºå—:", receipt.blockNumber);
                    
                    // æ£€æŸ¥äº¤æ˜“çŠ¶æ€
                    if (receipt.status === 1) {
                        alert(`è´¨æŠ¼æˆåŠŸï¼å‘¨æœŸï¼š${STAKE_DURATION_LABELS[selectedDuration]}\näº¤æ˜“ç¡®è®¤ï¼ŒåŒºå—: ${receipt.blockNumber}`);
                        
                        // åˆ·æ–°æ•°æ®
                        await refreshData();
                        
                        // æ˜¾ç¤ºçŸ­æš‚çš„"æˆåŠŸ"çŠ¶æ€
                        stakeBtn.textContent = "æˆåŠŸï¼";
                        stakeBtn.style.background = "linear-gradient(90deg, #10b981, #059669)";
                        
                        setTimeout(() => {
                            stakeBtn.textContent = originalText;
                            stakeBtn.style.background = "linear-gradient(90deg, #0d9488, #0a6c5f)";
                            stakeBtn.disabled = false;
                        }, 2000);
                        
                    } else {
                        throw new Error("äº¤æ˜“å¤±è´¥ï¼ŒçŠ¶æ€ä¸º0");
                    }
                    
                } catch (stakeError) {
                    console.error("è´¨æŠ¼äº¤æ˜“é”™è¯¯:", stakeError);
                    
                    if (stakeError.code === 4001) {
                        alert("ç”¨æˆ·æ‹’ç»è´¨æŠ¼äº¤æ˜“");
                    } else if (stakeError.reason) {
                        if (stakeError.reason.includes("insufficient allowance")) {
                            alert("æˆæƒä¸è¶³ï¼Œè¯·é‡æ–°æˆæƒ");
                        } else if (stakeError.reason.includes("transfer amount exceeds balance")) {
                            alert("ä½™é¢ä¸è¶³ï¼Œè¯·æ£€æŸ¥USDTä½™é¢");
                        } else if (stakeError.reason.includes("stake amount too high")) {
                            alert("è´¨æŠ¼é‡‘é¢è¶…è¿‡é™åˆ¶");
                        } else if (stakeError.reason.includes("Invalid stake index")) {
                            alert("æ— æ•ˆçš„è´¨æŠ¼å‘¨æœŸ");
                        } else {
                            alert(`è´¨æŠ¼å¤±è´¥: ${stakeError.reason}`);
                        }
                    } else if (stakeError.message?.includes("insufficient funds")) {
                        alert("Gasè´¹ç”¨ä¸è¶³ï¼Œè¯·ç¡®ä¿é’±åŒ…ä¸­æœ‰è¶³å¤Ÿçš„BNB/ETH");
                    } else {
                        alert(`è´¨æŠ¼å¤±è´¥: ${stakeError.message || "æœªçŸ¥é”™è¯¯"}`);
                    }
                    throw stakeError;
                }
                
            } catch (error) {
                console.error("è´¨æŠ¼è¿‡ç¨‹é”™è¯¯:", error);
                throw error;
            } finally {
                stakeBtn.disabled = false;
                stakeBtn.textContent = originalText;
            }
            
        } catch (error) {
            console.error("è´¨æŠ¼å¤±è´¥:", error);
            
            // é€šç”¨é”™è¯¯å¤„ç†
            if (error.code === 4001) {
                alert("ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“");
            } else if (error.code === -32603) {
                alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒGasè®¾ç½®");
            } else if (error.reason) {
                alert(`åˆçº¦é”™è¯¯: ${error.reason}`);
            } else if (error.message === "ç”¨æˆ·å–æ¶ˆ") {
                // ç”¨æˆ·å–æ¶ˆï¼Œä¸æ˜¾ç¤ºé”™è¯¯
            } else if (error.message) {
                alert(`é”™è¯¯: ${error.message}`);
            } else {
                alert("è´¨æŠ¼å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯");
            }
        }
    }

    // ã€5. èµå›é€»è¾‘ã€‘
    async function handleUnstake(index) {
        if (!userAddress) {
            alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
        }
        
        try {
            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            const confirmUnstake = confirm("ç¡®è®¤è¦èµå›è¯¥è´¨æŠ¼å—ï¼Ÿ");
            if (!confirmUnstake) {
                return;
            }
            
            const tx = await stakingContract.unstakeFor(userAddress, index);
            console.log("èµå›äº¤æ˜“å·²å‘é€:", tx.hash);
            
            alert(`èµå›äº¤æ˜“å·²å‘é€ï¼Œè¯·ç­‰å¾…ç¡®è®¤\näº¤æ˜“å“ˆå¸Œ: ${tx.hash.substring(0, 10)}...`);
            
            const receipt = await tx.wait();
            console.log("èµå›ç¡®è®¤ï¼ŒåŒºå—:", receipt.blockNumber);
            
            if (receipt.status === 1) {
                alert("èµå›æˆåŠŸï¼");
                await refreshData();
            } else {
                throw new Error("äº¤æ˜“å¤±è´¥ï¼ŒçŠ¶æ€ä¸º0");
            }

        } catch (error) {
            console.error("èµå›å¤±è´¥:", error);
            
            if (error.code === 4001) {
                alert("ç”¨æˆ·æ‹’ç»äº†äº¤æ˜“");
            } else if (error.reason) {
                alert(`åˆçº¦é”™è¯¯: ${error.reason}`);
            } else if (error.message && error.message.includes("User denied")) {
                alert("ç”¨æˆ·å–æ¶ˆäº¤æ˜“");
            } else if (error.message && error.message.includes("insufficient funds")) {
                alert("Gasè´¹ç”¨ä¸è¶³ï¼Œè¯·ç¡®ä¿é’±åŒ…ä¸­æœ‰è¶³å¤Ÿçš„BNB/ETH");
            } else {
                alert(`èµå›å¤±è´¥: ${error.message || "æœªçŸ¥é”™è¯¯"}`);
            }
            throw error;
        }
    }

    // ã€ç½‘ç»œæ£€æŸ¥å‡½æ•°ã€‘
    async function checkNetwork() {
        if (!window.ethereum) {
            throw new Error("æœªæ£€æµ‹åˆ°ä»¥å¤ªåŠé’±åŒ…");
        }
        
        try {
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            const bscChainId = '0x38'; // BSCä¸»ç½‘
            const bscTestnetChainId = '0x61'; // BSCæµ‹è¯•ç½‘
            
            if (chainId !== bscChainId && chainId !== bscTestnetChainId) {
                const switchConfirm = confirm("å½“å‰ç½‘ç»œä¸æ˜¯BSCç½‘ç»œï¼Œæ˜¯å¦åˆ‡æ¢åˆ°BSCä¸»ç½‘ï¼Ÿ");
                if (switchConfirm) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: bscChainId }],
                        });
                    } catch (switchError) {
                        // å¦‚æœç½‘ç»œæœªæ·»åŠ ï¼Œå°è¯•æ·»åŠ BSCç½‘ç»œ
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: bscChainId,
                                    chainName: 'BNB Smart Chain Mainnet',
                                    nativeCurrency: {
                                        name: 'BNB',
                                        symbol: 'BNB',
                                        decimals: 18
                                    },
                                    rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                    blockExplorerUrls: ['https://bscscan.com/']
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }
                } else {
                    throw new Error("è¯·åœ¨BSCç½‘ç»œä¸­è¿›è¡Œæ“ä½œ");
                }
            }
        } catch (error) {
            console.error("ç½‘ç»œæ£€æŸ¥å¤±è´¥:", error);
            if (error.code === 4001) {
                throw new Error("ç”¨æˆ·æ‹’ç»åˆ‡æ¢ç½‘ç»œ");
            } else {
                throw error;
            }
        }
    }
    
    // ã€é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨ã€‘
    window.addEventListener('beforeunload', () => {
        Object.keys(countdownTimers).forEach(id => {
            clearInterval(countdownTimers[id]);
        });
    });

    // ã€åˆå§‹è¿æ¥é’±åŒ…ã€‘
    window.addEventListener('load', () => {
        if (typeof window.ethereum !== 'undefined') {
            // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
            window.ethereum.request({ method: 'eth_accounts' })
                .then(accounts => {
                    if (accounts.length > 0) {
                        connectWallet();
                    }
                });
        }
    });
</script>
</body>
</html>